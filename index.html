<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NPA Image Lab v2.1 ‚Äî Creator Sync Edition</title>
<meta name="description" content="AI Image Generator + FB-Pro Caption Builder yang sinkron dengan NPA Smart System." />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f7fbff; --card:#ffffff; --text:#0b2447; --muted:#5b6b82;
    --brand:#1e66ff; --brand-2:#67a8ff; --ring:#cfe3ff; --ok:#12b76a; --warn:#ffb020; --danger:#ef4444;
  }
  .dark{
    --bg:#0c1220; --card:#0f172a; --text:#e6f0ff; --muted:#9bb0d1;
    --brand:#6aa8ff; --brand-2:#3b82f6; --ring:#1e3a8a; --ok:#34d399; --warn:#fbbf24; --danger:#f87171;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.6 Inter,system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:1100px;margin:auto;padding:28px 18px}
  .header{display:flex;gap:16px;align-items:center;margin-bottom:18px}
  .badge{background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#fff;padding:8px 12px;border-radius:999px;font-weight:700}
  h1{font-size:34px;line-height:1.15;margin:6px 0 10px}
  .lead{color:var(--muted);max-width:760px}
  .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:18px;margin-top:18px}
  @media (max-width:960px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:18px}
  .title{display:flex;align-items:center;gap:10px;font-weight:800;margin:2px 0 12px}
  .title .dot{width:9px;height:9px;border-radius:99px;background:var(--brand)}
  label{display:block;font-weight:700;margin:14px 0 6px}
  select,textarea,input[type="text"]{
    width:100%;padding:12px 14px;border:1px solid var(--ring);
    background:#fff;color:#111;border-radius:10px;font:inherit;outline:none;
  }
  .dark select,.dark textarea,.dark input[type="text"]{background:#0b1220;color:#e6f0ff}
  textarea{min-height:120px;resize:vertical}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 14px;border-radius:12px;
       background:var(--brand);color:#fff;border:none;font-weight:800;cursor:pointer;box-shadow:0 6px 18px rgba(30,102,255,.22)}
  .btn.secondary{background:#e9f2ff;color:#113b8a}
  .btn.ghost{background:transparent;border:1px dashed var(--ring);color:var(--text)}
  .btn.ok{background:var(--ok)} .btn.warn{background:var(--warn);color:#132}
  .btn.danger{background:var(--danger)}
  .toolbar{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
  .hint{font-size:13px;color:var(--muted)}
  canvas{width:100%;height:auto;border-radius:14px;border:1px solid var(--ring);background:#fff}
  .preview-meta{display:flex;align-items:center;justify-content:space-between;margin:8px 0 10px}
  .pill{padding:6px 10px;border-radius:999px;background:#eef6ff;color:#13407a;font-weight:700}
  .dark .pill{background:#0b1a34;color:#9bc2ff}
  .list{display:flex;flex-direction:column;gap:10px}
  .item{padding:10px;border:1px dashed var(--ring);border-radius:12px}
  .item small{color:var(--muted)}
  .right h3{margin:0 0 8px}
  .switch{margin-left:auto}
</style>
</head>
<body>
<div class="wrap" id="app">
  <div class="header">
    <span class="badge">NPA Image Lab</span>
    <div class="switch">
      <button id="toggleTheme" class="btn ghost" title="Mode siang/malam">üåô / ‚òÄÔ∏è</button>
    </div>
  </div>
  <h1>AI Image Generator + Caption Builder (FB Pro)</h1>
  <p class="lead">Bikin gambar bertema <b>3iReborn</b> / <b>NPA Smart</b> / <b>Nganggur Aja</b>, lalu
    dapatkan <b>caption aman untuk FB Pro</b> (tanpa link di caption, ajakan interaksi natural).
    Tersinkron dengan <b>NPA Smart System</b> untuk broadcast ke leader aktif.</p>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="title"><span class="dot"></span>Pengaturan Karya</div>
      <div class="row">
        <div>
          <label>Tema</label>
          <select id="theme">
            <option>3iReborn</option>
            <option>NPA Smart</option>
            <option>Nganggur Aja</option>
          </select>
        </div>
        <div>
          <label>Gaya Visual</label>
          <select id="style">
            <option>Clean Corporate</option>
            <option>Bold Gradient</option>
            <option>Soft Pastel</option>
            <option>Photo Collage</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Rasio</label>
          <select id="ratio">
            <option>1:1 (Feed)</option>
            <option>4:5 (Portrait)</option>
            <option>9:16 (Reels)</option>
          </select>
        </div>
        <div>
          <label>Tone Caption</label>
          <select id="tone">
            <option>‚ú® Inspiratif</option>
            <option>ü§ù Humanis</option>
            <option>üìà Edukatif</option>
            <option>üî• Aksi Halus</option>
          </select>
        </div>
      </div>

      <label>Prompt (boleh edit)</label>
      <textarea id="prompt"></textarea>
      <div class="toolbar">
        <button class="btn secondary" id="autoPrompt">üéØ Auto Prompt</button>
        <button class="btn ghost" id="saveTpl">üíæ Simpan Template</button>
        <button class="btn ghost" id="loadTpl">üìÇ Muat Template</button>
        <button class="btn danger" id="clearTpl">üóëÔ∏è Hapus Template</button>
      </div>

      <div class="toolbar" style="margin-top:14px">
        <button class="btn" id="gen">üöÄ Generate Gambar</button>
        <button class="btn ok" id="dl" disabled>‚¨áÔ∏è Download</button>
      </div>
      <p class="hint">Generator ini membuat <b>mockup visual</b> berbasis kanvas (tanpa API). Untuk produksi AI eksternal,
        cukup gunakan prompt di atas ke tool favoritmu, lalu caption-nya tetap dari panel kanan.</p>
    </div>

    <!-- RIGHT -->
    <div class="card right">
      <div class="title"><span class="dot"></span>Preview & Caption</div>
      <div class="preview-meta">
        <span class="pill" id="metaInfo">Preview: belum ada</span>
        <span class="hint" id="fonnteStatus">FonNTE: <b>cek otomatis‚Ä¶</b></span>
      </div>
      <canvas id="cv" width="1024" height="1024"></canvas>

      <h3>Caption (otomatis, aman untuk FB Pro)</h3>
      <textarea id="caption"></textarea>
      <div class="toolbar">
        <button class="btn secondary" id="copyCap">üìã Copy Caption</button>
        <button class="btn warn" id="regenCap">üîÅ Refresh Caption</button>
        <button class="btn ok" id="shareNPA">üì§ Kirim ke NPA Smart</button>
      </div>

      <div class="item" style="margin-top:14px">
        <b>Tips FB Pro:</b>
        <small>jangan letakkan link di caption. Taruh link di komentar pertama. Ajak interaksi natural
          (tulis ‚ÄúKetik: <b>SIAP</b> kalau kamu mau intip materinya‚Äù).</small>
      </div>

      <div class="list" id="tplList" style="display:none;margin-top:12px"></div>
    </div>
  </div>
</div>

<script>
/* ===== Utility: theme & time ===== */
const app = document.documentElement;
function applyAutoDark(){ const h=new Date().getHours(); if(h>=19||h<5) app.classList.add('dark'); }
applyAutoDark();
document.getElementById('toggleTheme').onclick=()=>app.classList.toggle('dark');

/* ===== Elements ===== */
const el = id => document.getElementById(id);
const theme = el('theme'), style = el('style'), ratio = el('ratio'), tone = el('tone');
const promptEl = el('prompt'), capEl = el('caption'), meta = el('metaInfo');
const cv = el('cv'), ctx = cv.getContext('2d');
const dlBtn = el('dl'), copyBtn = el('copyCap'), regenBtn = el('regenCap'), genBtn = el('gen');
const autoPromptBtn = el('autoPrompt'), shareBtn = el('shareNPA');
const fonnteStatus = el('fonnteStatus');
const saveTplBtn = el('saveTpl'), loadTplBtn = el('loadTpl'), clearTplBtn = el('clearTpl'), tplList = el('tplList');

/* ===== Defaults ===== */
const PROMPTS = {
  "3iReborn": "poster 3iReborn, perlindungan jiwa + investasi jangka panjang, suasana optimis profesional, ikon shield & growth, orang Indonesia tersenyum, tipografi modern tebal, aksen biru keemasan",
  "NPA Smart": "visual NPA Smart System, teknologi AI follow-up, smartphone UI elegan, ikon roket dan grafik naik, nuansa white-blue minimal, kesan produktif & rapi",
  "Nganggur Aja": "poster Nganggur Aja, gaya fun minimalis, orang santai pegang laptop/HP, konsep income cerdas, latar bersih, aksen biru langit & putih"
};
function setPrompt(){ promptEl.value = PROMPTS[theme.value] || PROMPTS["3iReborn"]; }
theme.onchange = setPrompt; setPrompt();

/* ===== Ratio size mapping ===== */
function sizeByRatio(r){
  if(r.startsWith("1:1")) return [1024,1024];
  if(r.startsWith("4:5")) return [1024,1280];
  return [1080,1920]; // 9:16
}

/* ===== Simple Canvas Generator (Mockup) ===== */
function drawPoster(){
  const [w,h] = sizeByRatio(ratio.value);
  cv.width=w; cv.height=h;

  // Background gradient based on theme/style
  const g = ctx.createLinearGradient(0,0,w,h);
  if(theme.value==="3iReborn"){ g.addColorStop(0,"#ebf3ff"); g.addColorStop(1,"#cfe3ff"); }
  else if(theme.value==="NPA Smart"){ g.addColorStop(0,"#f3f6ff"); g.addColorStop(1,"#e6f0ff"); }
  else { g.addColorStop(0,"#eef9ff"); g.addColorStop(1,"#def2ff"); }
  ctx.fillStyle=g; ctx.fillRect(0,0,w,h);

  // Accent shapes
  ctx.globalAlpha=0.25; ctx.fillStyle="#1e66ff";
  if(style.value==="Bold Gradient"){
    ctx.beginPath(); ctx.arc(w*0.85,h*0.2,w*0.35,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(w*0.1,h*0.9,w*0.5,0,Math.PI*2); ctx.fill();
  } else if(style.value==="Photo Collage"){
    ctx.fillRect(w*0.55,h*0.1,w*0.35,h*0.28);
    ctx.fillRect(w*0.1,h*0.5,w*0.35,h*0.25);
  } else {
    ctx.fillRect(0,h-28,w,28);
  }
  ctx.globalAlpha=1;

  // Header badge
  ctx.fillStyle="#1e293b"; ctx.font=`${Math.floor(w*0.032)}px Inter`;
  const badge = theme.value==="3iReborn"?"3iReborn":"NPA Smart System";
  ctx.fillText(badge, 28, 42);

  // Big title
  ctx.fillStyle="#0b2447"; ctx.font=`bold ${Math.floor(w*0.075)}px Inter`;
  const title = theme.value==="3iReborn"?"Perlindungan + Investasi":"Otomasi Follow-Up Cerdas";
  wrapText(title, 28, Math.floor(h*0.18), Math.floor(w*0.85), Math.floor(w*0.085));

  // Subtitle
  ctx.fillStyle="#334155"; ctx.font=`${Math.floor(w*0.036)}px Inter`;
  const sub =
    theme.value==="3iReborn" ?
    "Tenang hari ini, siap untuk masa depan." :
    "Prospek jalan, follow-up tetap rapi.";
  wrapText(sub, 28, Math.floor(h*0.38), Math.floor(w*0.8), Math.floor(w*0.045));

  // CTA pill
  const pillW = Math.min( Math.floor(w*0.62), 640 ), pillH = Math.floor(w*0.09);
  const x = 28, y = Math.floor(h*0.48);
  roundRect(ctx, x,y,pillW,pillH, Math.floor(pillH/2), "#1e66ff");
  ctx.fillStyle="#fff"; ctx.font=`bold ${Math.floor(w*0.04)}px Inter`;
  ctx.fillText("Gabung Sekarang", x+24, y+Math.floor(pillH*0.65));

  // Footer info
  ctx.fillStyle="#0b2447"; ctx.font=`bold ${Math.floor(w*0.038)}px Inter`;
  ctx.fillText(theme.value==="Nganggur Aja" ? "Nganggur Aja ‚Ä¢ Income Cerdas" : "3iReborn ‚Ä¢ NPA Smart System", 28, h-36);

  meta.innerText = `Preview: ${w}√ó${h} ‚Ä¢ ${ratio.value}`;
  dlBtn.disabled=false;
}
function roundRect(c,x,y,w,h,r,color){ c.fillStyle=color; c.beginPath();
  c.moveTo(x+r,y); c.arcTo(x+w,y,x+w,y+h,r); c.arcTo(x+w,y+h,x,y+h,r);
  c.arcTo(x,y+h,x,y,r); c.arcTo(x,y,x+w,y,r); c.closePath(); c.fill();
}
function wrapText(text,x,y,maxWidth,lineHeight){
  const words=text.split(' '); let line='', yy=y; 
  for (let n=0;n<words.length;n++){ const test=line+words[n]+' ';
    if(ctx.measureText(test).width>maxWidth && n>0){
      ctx.fillText(line,x,yy); line=words[n]+' '; yy+=lineHeight;
    } else line=test;
  } ctx.fillText(line,x,yy);
}

/* ===== Caption Generator ===== */
function genCaption(){
  const t = theme.value, tn = tone.value;
  const hooks = {
    "3iReborn":[
      "Pengen hidup lebih tenang tanpa takut esok hari?",
      "Ada cara rapi buat proteksi + nabung jangka panjang.",
      "Banyak yang kaget setelah tahu ini sesederhana itu."
    ],
    "NPA Smart":[
      "Follow-up capek? Ada cara yang lebih cerdas.",
      "Prospek jalan terus meski kamu lagi sibuk.",
      "Bangun sistem, biar sistem bantu bales."
    ],
    "Nganggur Aja":[
      "Santai boleh, income tetap harus jalan dong üòâ",
      "Kerja cerdas itu soal sistem, bukan jam lembur.",
      "Main HP bisa tetap produktif, asal tahu caranya."
    ]
  }[t];

  const body =
    tn.includes("Inspiratif") ? 
      "Pelan tapi pasti. Sedikit demi sedikit, kita siapkan masa depan tanpa ngilangin kenyamanan hari ini." :
    tn.includes("Humanis") ?
      "Belajar bareng, dibimbing santai. Yang penting, kamu nyaman jalaninnya dan paham step-by-step." :
    tn.includes("Eduk") ?
      "Konsepnya sederhana: proteksi diri/keluarga + tabungan/investasi jangka panjang, ditambah sistem follow-up digital." :
      "Kalau kamu pengin mulai dari hal sederhana, ini bisa jadi pintu masuk yang aman dan realistis.";

  const cta = "Ketik: SIAP di komentar (biar aku kirim rangkuman materinya).";
  const hash = t==="3iReborn" ? "#3iReborn #NPA" : (t==="NPA Smart" ? "#NPASmart #AutoFollowUp" : "#NganggurAja #SmartIncome");

  capEl.value = `‚Ä¢ ${hooks[0]}\n‚Ä¢ ${hooks[1]}\n‚Ä¢ ${hooks[2]}\n\n${body}\n\n${cta}\n${hash}`;
}
genCaption();

/* ===== Buttons ===== */
genBtn.onclick = ()=>{
  if(!promptEl.value.trim()) setPrompt();
  drawPoster(); genCaption();
};
dlBtn.onclick = ()=>{
  const a=document.createElement('a');
  a.href=cv.toDataURL('image/png'); 
  const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
  a.download=`npa-image-${ts}.png`; a.click();
};
copyBtn.onclick=()=>{ capEl.select(); document.execCommand('copy'); copyBtn.innerText="‚úÖ Tersalin!"; setTimeout(()=>copyBtn.innerText="üìã Copy Caption",900); };
regenBtn.onclick = genCaption;
autoPromptBtn.onclick = setPrompt;

/* ===== FonNTE Sharing (optional) ===== */
function checkFonNTE(){
  const tk = localStorage.getItem('fonnte_token');
  if(tk){ fonnteStatus.innerHTML = 'FonNTE: <b>aktif (local)</b>'; return tk; }
  fonnteStatus.innerHTML = 'FonNTE: <b>belum dihubungkan</b>';
  return null;
}
checkFonNTE();

shareBtn.onclick = async ()=>{
  const token = checkFonNTE();
  if(!token){ alert("Token FonNTE tidak ditemukan di perangkat ini.\nBuka Admin Pusat/Leader NPA Smart di perangkat yang sama, set token sekali, lalu kembali ke sini."); return; }

  // Ambil daftar nomor leader (kalau ada) dari localStorage (dipakai juga oleh NPA Smart v6.x)
  const raw = localStorage.getItem('npa_leaders');
  if(!raw){ alert("Daftar leader tidak ditemukan. Pastikan kamu sudah membuat link leader di Admin Leader."); return; }
  const leaders = JSON.parse(raw); // [{name,wa},...]
  if(!Array.isArray(leaders)||leaders.length===0){ alert("Daftar leader kosong."); return; }

  const msg = `*Konten Baru untuk FB Pro*\n\n${capEl.value}\n\n(Ini kiriman otomatis dari NPA Image Lab v2.1)`;
  const targets = leaders.map(x=>x.wa.replace(/^\+?/,'')); // format 62...

  try{
    // NB: endpoint asli FonNTE: https://api.fonnte.com/send
    // Di sini kita hanya simulasikan request agar aman dipakai di GitHub Pages.
    console.log("Simulasi kirim ke FonNTE:", targets, msg.slice(0,100)+"...");
    alert(`Simulasi kirim ke ${targets.length} leader.\n\nUntuk produksi, aktifkan endpoint FonNTE di server atau izinkan CORS.`);
  }catch(e){
    alert("Gagal kirim (cek token/daftar leader)."); console.error(e);
  }
};

/* ===== Template save/load ===== */
function refreshTplList(){
  const arr = JSON.parse(localStorage.getItem('npa_img_templates')||'[]');
  tplList.innerHTML=''; tplList.style.display = arr.length? 'block':'none';
  arr.forEach((t,i)=>{
    const d=document.createElement('div'); d.className='item';
    d.innerHTML = `<b>${t.name}</b><br/><small>${t.theme} ‚Ä¢ ${t.style} ‚Ä¢ ${t.ratio} ‚Ä¢ ${t.tone}</small>
      <div class="toolbar" style="margin-top:8px">
        <button class="btn secondary" data-act="load" data-i="${i}">Muat</button>
        <button class="btn danger" data-act="del" data-i="${i}">Hapus</button>
      </div>`;
    tplList.appendChild(d);
  });
}
saveTplBtn.onclick=()=>{
  const name = prompt("Nama template:");
  if(!name) return;
  const arr = JSON.parse(localStorage.getItem('npa_img_templates')||'[]');
  arr.push({name, theme:theme.value, style:style.value, ratio:ratio.value, tone:tone.value, prompt:promptEl.value});
  localStorage.setItem('npa_img_templates', JSON.stringify(arr));
  refreshTplList();
};
loadTplBtn.onclick=refreshTplList;
clearTplBtn.onclick=()=>{ localStorage.removeItem('npa_img_templates'); refreshTplList(); };
tplList.onclick=e=>{
  const btn=e.target.closest('button'); if(!btn) return;
  const arr = JSON.parse(localStorage.getItem('npa_img_templates')||'[]');
  const i = +btn.dataset.i; const t=arr[i];
  if(btn.dataset.act==='load' && t){
    theme.value=t.theme; style.value=t.style; ratio.value=t.ratio; tone.value=t.tone; promptEl.value=t.prompt;
    genCaption(); window.scrollTo({top:0,behavior:'smooth'});
  }
  if(btn.dataset.act==='del'){ arr.splice(i,1); localStorage.setItem('npa_img_templates', JSON.stringify(arr)); refreshTplList(); }
};
</script>
</body>
</html>
